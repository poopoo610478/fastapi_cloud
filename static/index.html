<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>FastAPI ä½¿ç”¨è€… CRUD ç³»çµ±</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            margin: 40px;
            background-color: #f8f9fa;
        }
        h1 { color: #0078D7; }
        input, button { padding: 6px; margin: 5px; }
        table {
            border-collapse: collapse;
            width: 90%;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        th { background-color: #007bff; color: white; }
        tr:hover { background-color: #f2f2f2; }
        .section, .query-box {
            background: white;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
            width: 90%;
        }
        .btn {
            background-color: #0078D7;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn:hover { background-color: #005EA6; }
        .btn-danger {
            background-color: #d9534f;
        }
        .btn-danger:hover { background-color: #b52b27; }

        /* ğŸ”´ æ–°å¢ï¼šç€è¦½å™¨è­¦å‘Šæ¨£å¼ */
        #browser-warning {
            display: none;
            background-color: #ffcccc;
            color: #900;
            border: 1px solid #d00;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            width: 90%;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <!-- ğŸ”´ æ–°å¢ï¼šç€è¦½å™¨åµæ¸¬è­¦å‘Š -->
    <div id="browser-warning">
        âš ï¸ æ‚¨ç›®å‰ä½¿ç”¨çš„æ˜¯èˆŠç‰ˆç€è¦½å™¨ï¼ˆIE æˆ–å‚³çµ± Edgeï¼‰ï¼Œ
        æ­¤ç¶²ç«™éƒ¨åˆ†åŠŸèƒ½å°‡ç„¡æ³•æ­£å¸¸é‹ä½œã€‚<br>
        ğŸ‘‰ å»ºè­°ä½¿ç”¨ <strong>Google Chrome</strong> æˆ– <strong>æ–°ç‰ˆ Microsoft Edge</strong>ã€‚
    </div>

    <!-- API æ–‡ä»¶èˆ‡æ¸¬è©¦ -->
    <div style="background:#f0f8ff; border:1px solid #ccc; padding:15px; border-radius:8px; width:90%;">
        <h2>ğŸ”§ API æ–‡ä»¶èˆ‡æ¸¬è©¦</h2>
        <button onclick="window.open('/docs', '_blank')" 
                style="background-color:#007bff; color:white; border:none; border-radius:4px; padding:8px 12px; cursor:pointer;">
            Swagger UI - äº’å‹•å¼ API æ¸¬è©¦
        </button>
        <button onclick="window.open('/redoc', '_blank')" 
                style="background-color:#28a745; color:white; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; margin-left:10px;">
            ReDoc - API æ–‡ä»¶é–±è®€
        </button>
    </div>
    <br>

    <h1>FastAPI ä½¿ç”¨è€… CRUD ç³»çµ±</h1>

    <div class="section">
        <h3>ä½¿ç”¨è€…è³‡æ–™</h3>
        <form id="createForm">
            IDï¼š<input type="number" id="userId" name="id" placeholder="ä¿®æ”¹æ™‚è‡ªå‹•å¡«å…¥">
            å§“åï¼š<input type="text" name="name" id="userName" required>
            Emailï¼š<input type="email" name="email" id="userEmail" required>
            <button type="submit" class="btn">æ–°å¢</button>
            <button type="button" id="updateBtn" class="btn" style="background-color:#17a2b8; display:none;" onclick="confirmUpdate()">ç¢ºèªæ›´æ–°</button>
        </form>
    </div>

    <div class="query-section">
        <div class="query-box">
            <button onclick="fetchUsers()" class="btn">æŸ¥è©¢æ‰€æœ‰ä½¿ç”¨è€…</button>
            IDï¼š<input type="number" id="getUserId" min="1" placeholder="æŸ¥è©¢å–®ä¸€ä½¿ç”¨è€…">
            <button onclick="getUser()" class="btn">æŸ¥è©¢</button>
            æœå°‹ï¼š<input type="text" id="searchKeyword" placeholder="ä¾å§“åæˆ–Email">
            <button onclick="searchUsers()" class="btn">æœå°‹</button>
        </div>
    </div>

    <div id="result"></div>

    <script>
        const BASE_URL = "http://10.16.60.4:8000";

        // ğŸ” æ–°å¢ï¼šç€è¦½å™¨åµæ¸¬
        function detectBrowser() {
            const ua = window.navigator.userAgent;
            const isIE = ua.indexOf('MSIE ') > -1 || ua.indexOf('Trident/') > -1;
            const isOldEdge = ua.indexOf('Edge/') > -1 && ua.indexOf('Edg/') === -1;
            if (isIE || isOldEdge) {
                document.getElementById("browser-warning").style.display = "block";
            }
        }
        detectBrowser();

        // === ä¸»è¦åŠŸèƒ½ ===
        async function fetchUsers() {
            const res = await fetch(`${BASE_URL}/users/`);
            const data = await res.json();
            renderTable(data);
        }

        async function getUser() {
            const id = document.getElementById("getUserId").value;
            if (!id) return alert("è«‹è¼¸å…¥ IDï¼");
            const res = await fetch(`${BASE_URL}/users/${id}`);
            const data = await res.json();
            renderTable([data]);
        }

        async function searchUsers() {
            const kw = document.getElementById("searchKeyword").value.trim();
            if (!kw) return alert("è«‹è¼¸å…¥é—œéµå­—ï¼");
            const res = await fetch(`${BASE_URL}/search/?keyword=${encodeURIComponent(kw)}`);
            const data = await res.json();
            renderTable(data);
        }

        document.getElementById("createForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const res = await fetch(`${BASE_URL}/users/`, { method: "POST", body: formData });
            const msg = await res.json();
            alert(msg.message);
            e.target.reset();
            fetchUsers();
        });

        function editUser(id, name, email) {
            document.getElementById("userId").value = id;
            document.getElementById("userName").value = name;
            document.getElementById("userEmail").value = email;
            document.getElementById("updateBtn").style.display = "inline-block";
        }

        async function confirmUpdate() {
            const id = document.getElementById("userId").value;
            const name = document.getElementById("userName").value;
            const email = document.getElementById("userEmail").value;
            if (!id || !name || !email) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼");
            const formData = new FormData();
            formData.append("name", name);
            formData.append("email", email);
            const res = await fetch(`${BASE_URL}/users/${id}`, { method: "PUT", body: formData });
            const msg = await res.json();
            alert(msg.message);
            document.getElementById("createForm").reset();
            document.getElementById("updateBtn").style.display = "none";
            fetchUsers();
        }

        async function deleteUser(id) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ID=${id} çš„ä½¿ç”¨è€…å—ï¼Ÿ`)) return;
            const res = await fetch(`${BASE_URL}/users/${id}`, { method: "DELETE" });
            const msg = await res.json();
            alert(msg.message);
            fetchUsers();
        }

        function renderTable(data) {
            if (!data || data.length === 0) {
                document.getElementById("result").innerHTML = "<p style='color:red;'>æŸ¥ç„¡è³‡æ–™ã€‚</p>";
                return;
            }

            let html = `
            <table>
                <thead>
                    <tr><th>ID</th><th>å§“å</th><th>Email</th><th>æ“ä½œ</th></tr>
                </thead>
                <tbody>`;
            for (const row of data) {
                html += `
                    <tr>
                        <td>${row.id}</td>
                        <td>${row.name}</td>
                        <td>${row.email}</td>
                        <td>
                            <button class="btn" style="background-color:#f0ad4e;" onclick="editUser(${row.id}, '${row.name}', '${row.email}')">ä¿®æ”¹</button>
                            <button class="btn btn-danger" onclick="deleteUser(${row.id})">åˆªé™¤</button>
                        </td>
                    </tr>`;
            }
            html += "</tbody></table>";
            document.getElementById("result").innerHTML = html;
        }
    </script>
</body>
</html>
